name: Build Flutter Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'  # استخدم أحدث إصدار مستقر
        channel: 'stable'
        cache: true
    
    - name: Get Flutter dependencies
      run: flutter pub get
    
    - name: Run Flutter doctor
      run: flutter doctor -v
    
    - name: Analyze Flutter code
      run: flutter analyze
    
    - name: Run Flutter tests
      run: flutter test
    
    - name: Build Android APK (Debug)
      run: flutter build apk --debug --split-per-abi
    
    - name: Build Android APK (Release)
      run: flutter build apk --release --split-per-abi
    
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: build/app/outputs/flutter-apk/app-*-debug.apk
        retention-days: 30
    
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: build/app/outputs/flutter-apk/app-*-release.apk
        retention-days: 90
    
    # إنشاء Android App Bundle (AAB) للنشر في Google Play Store
    - name: Build Android App Bundle (Release)
      run: flutter build appbundle --release
    
    - name: Upload Release AAB
      uses: actions/upload-artifact@v4
      with:
        name: release-aab
        path: build/app/outputs/bundle/release/app-release.aab
        retention-days: 90

  # مهمة إضافية لرفع الملفات إلى الإصدارات
  create-release:
    needs: build-android
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-apk/*.apk
          release-aab/*.aab
        body: |
          ## تطبيق الفواتير العربي - إصدار ${{ github.ref_name }}
          
          ### الملفات المتوفرة:
          - **APK**: ملف التثبيت المباشر للأندرويد
          - **AAB**: ملف النشر في متجر Google Play
          
          ### المميزات في هذا الإصدار:
          - إنشاء وحفظ الفواتير
          - دعم اللغة العربية
          - تصدير الفواتير كـ PDF
          - حفظ البيانات محلياً بدون الحاجة للإنترنت
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
